{"version":3,"file":"CoLang.js","names":["CoLang","params","cachedParse","withCache","onError","checkCondition","bind","formatCondition","getFieldEntries","evaluateFieldTokens","clearCache","condition","lexer","Lexer","Parser","ast","error","trackIdentifier","getParseResult","isError","formatConditionVisitor","FormatConditionVisitor","accept","formattedCondition","e","message","CoLangError","source","ESource","FORMAT_VISITOR","options","trackId","extractFieldNamesVisitor","ExtractFieldNamesVisitor","fieldNames","fieldTokens","evaluateConditionVisitor","EvaluateConditionVisitor","evaluationResult","triggeredFieldTokens","EVALUATE_VISITOR"],"sources":["../src/CoLang.ts"],"sourcesContent":["import { CoLangError } from './CoLangError';\nimport { Lexer } from './Lexer';\nimport { Parser } from './Parser';\nimport { FieldTokenModel } from './FieldTokenModel';\nimport { FormatConditionVisitor } from './FormatConditionVisitor';\nimport { ExtractFieldNamesVisitor } from './ExtractFieldNamesVisitor';\nimport { EvaluateConditionVisitor } from './EvaluateConditionVisitor';\nimport { ESource, ParseCtx } from './types';\n\ntype TCondition = string;\nexport type TOnError = (error: CoLangError, condition: string, trackId?: string | null) => void;\n\n/** ast - Abstract Syntax Tree (AST) */\ninterface IParseResult {\n  ast: ParseCtx;\n  error?: CoLangError;\n}\n\nexport interface IEvaluationReport {\n  evaluationResult: boolean;\n  triggeredFieldTokens: FieldTokenModel[] | null;\n}\n\nexport interface IAdditionalOptions {\n  trackId?: string | null;\n}\n\nexport class CoLang {\n  private cachedParse: Record<TCondition, IParseResult>;\n  private withCache: boolean = true;\n  private readonly onError?: TOnError;\n\n  constructor(params?: { withCache?: boolean; onError?: TOnError }) {\n    this.cachedParse = {};\n\n    if (params) {\n      this.withCache = params.withCache ?? true;\n      this.onError = params.onError;\n    }\n\n    this.checkCondition = this.checkCondition.bind(this);\n    this.formatCondition = this.formatCondition.bind(this);\n    this.getFieldEntries = this.getFieldEntries.bind(this);\n    this.evaluateFieldTokens = this.evaluateFieldTokens.bind(this);\n    this.clearCache = this.clearCache.bind(this);\n  }\n\n  private getParseResult(condition: string) {\n    if (this.cachedParse[condition]) return this.cachedParse[condition];\n\n    const lexer = new Lexer(condition);\n    const { ast, error } = new Parser(lexer);\n\n    if (this.withCache) {\n      this.cachedParse[condition] = { ast, error };\n    }\n\n    return { ast, error };\n  }\n\n  private isError(\n    error: CoLangError | undefined,\n    condition: string,\n    trackIdentifier?: string | null\n  ) {\n    if (error) {\n      if (this.onError) this.onError(error, condition, trackIdentifier);\n      return true;\n    }\n\n    return false;\n  }\n\n  checkCondition(condition: string, withCache = false) {\n    this.withCache = withCache;\n    const { error } = this.getParseResult(condition);\n\n    if (error && this.onError) this.onError(error, condition);\n\n    return error;\n  }\n\n  formatCondition(condition: string, withCache = false) {\n    this.withCache = withCache;\n    const { ast, error } = this.getParseResult(condition);\n\n    if (this.isError(error, condition)) return condition;\n\n    try {\n      const formatConditionVisitor = new FormatConditionVisitor();\n      ast.accept(formatConditionVisitor);\n\n      return formatConditionVisitor.formattedCondition;\n    } catch (e) {\n      const { message } = e as Error;\n      const error = new CoLangError({ message, source: ESource.FORMAT_VISITOR });\n\n      if (this.onError) this.onError(error, condition);\n\n      return condition;\n    }\n  }\n\n  getFieldEntries(condition: string, options?: IAdditionalOptions) {\n    const { ast, error } = this.getParseResult(condition);\n\n    if (this.isError(error, condition, options?.trackId)) return null;\n\n    const extractFieldNamesVisitor = new ExtractFieldNamesVisitor();\n    ast.accept(extractFieldNamesVisitor);\n\n    return extractFieldNamesVisitor.fieldNames;\n  }\n\n  evaluateFieldTokens(\n    condition: string,\n    fieldTokens: FieldTokenModel[],\n    options?: IAdditionalOptions\n  ) {\n    const { ast, error } = this.getParseResult(condition);\n\n    if (this.isError(error, condition, options?.trackId)) return null;\n\n    try {\n      const evaluateConditionVisitor = new EvaluateConditionVisitor(fieldTokens);\n      ast.accept(evaluateConditionVisitor);\n      const { evaluationResult, triggeredFieldTokens } = evaluateConditionVisitor;\n\n      return { evaluationResult, triggeredFieldTokens } as IEvaluationReport;\n    } catch (e) {\n      const { message } = e as Error;\n      const error = new CoLangError({ message, source: ESource.EVALUATE_VISITOR });\n\n      if (this.onError) this.onError(error, condition, options?.trackId);\n\n      return null;\n    }\n  }\n\n  clearCache() {\n    this.cachedParse = {};\n  }\n}\n"],"mappings":"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"}